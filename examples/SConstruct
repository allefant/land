# vi: syntax=python
import glob, os

try: os.mkdir("scons")
except OSError: pass

examples = [ex for ex in glob.glob("*") if os.path.isdir(ex) and ex != "scons"]

for ex in examples:
    srcdir = os.path.join(ex, "src")
    cdir = os.path.join(ex, "c")

    cfiles = []
    pyfiles = glob.glob(os.path.join(srcdir, "*.py"))

    for py in pyfiles:
        pyenv = Environment()
        pyenv.BuildDir(cdir, srcdir, duplicate = False)
        h = cdir + "/" + py[len(srcdir) + 1:-3] + ".h"
        c = cdir + "/" + py[len(srcdir) + 1:-3] + ".c"
        name = py[len(srcdir) + 1:-3]
        pyenv.Command([c, h], py, "scramble.py -i %s -c %s -h %s -n %s" % (py, c, h, name))
        cfiles += [c]

    env = Environment()

    BUILDDIR = os.path.join("scons", "build")

    env.Append(CPPPATH = ["../include/land"])
    env.Append(LIBPATH = ["../lib/posix"])

    if ARGUMENTS.get("debug", 0):
        env.Append(CCFLAGS = "-g -DLAND_MEMLOG")
        env.Append(LIBS = ["landd", "agld"])
        env.ParseConfig("allegro-config --libs debug")
        BUILDDIR = os.path.join(BUILDDIR, "debug")
    else:
        env.Append(LIBS = ["land", "agl"])
        env.ParseConfig("allegro-config --libs release")
        BUILDDIR = os.path.join(BUILDDIR, "release")

    BUILDDIR = os.path.join(BUILDDIR, ex)

    env.Append(LIBS = ["ldpng", "png", "fudgefont",
        "freetype", "GL", "GLU", "dumb", "jpgal"])

    env.SConsignFile("scons/signatures")

    env.BuildDir(BUILDDIR, cdir, duplicate = False)
    sources = [os.path.join(BUILDDIR, os.path.split(x)[1]) for x in cfiles]
    prog = env.Program(os.path.join(ex, ex), sources)

